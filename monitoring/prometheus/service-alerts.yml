groups:
  - name: service-alerts
    rules:
      # ========================================
      # 서비스 다운 알림
      # ========================================
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          description: "Service {{ $labels.application }} is down (Instance: {{ $labels.instance }})"

      # ========================================
      # 메트릭 푸시 중단 알림
      # ========================================
      - alert: ServicePushStopped
        expr: time() - push_time_seconds > 90
        for: 1m
        labels:
          severity: critical
        annotations:
          description: "Service {{ $labels.job }} stopped pushing metrics (last push: {{ $value | humanizeDuration }} ago)"

      # ========================================
      # 높은 레이턴시 알림
      # ========================================
      - alert: ServiceLatencyHigh
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, application)) > 1
        for: 2m
        labels:
          severity: warning
        annotations:
          description: "Service {{ $labels.application }} has high latency (p95 > 1s). Instance: {{ $labels.instance }}"

      # ========================================
      # 서비스 재시작 알림
      # ========================================
      - alert: ServiceRestarted
        expr: changes(process_uptime_seconds{application!=""}[1m]) > 0
        for: 1m
        labels:
          severity: info
        annotations:
          description: "Service {{ $labels.application }} restarted."

      # ========================================
      # 높은 에러율 알림
      # ========================================
      - alert: HighErrorRate
        expr: |
          sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (application)
          /
          sum(rate(http_server_requests_seconds_count[5m])) by (application) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          description: "Service {{ $labels.application }} has high error rate (>5%)"

      # ========================================
      # 메모리 사용률 높음 알림
      # ========================================
      - alert: HighMemoryUsage
        expr: |
          jvm_memory_used_bytes{area="heap"}
          /
          jvm_memory_max_bytes{area="heap"} > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          description: "Service {{ $labels.application }} heap memory usage is above 90%"
