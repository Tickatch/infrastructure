user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml;

    # ============ UPSTREAM 정의 ============

    # Infrastructure Services
    upstream zipkin {
        server tickatch-zipkin:9411;
    }

    upstream eureka1 {
        server eureka-server-1:3150;
    }

    upstream eureka2 {
        server eureka-server-2:3151;
    }

    upstream config {
        server config-server:3100;
    }

    # Monitoring Services
    upstream grafana {
        server grafana:3000;
    }

    upstream kibana {
        server kibana:5601;
    }

    upstream prometheus {
        server prometheus:9090;
    }

    upstream pushgateway {
        server pushgateway:9091;
    }

    upstream alertmanager {
        server alertmanager:9093;
    }

    upstream rabbitmq_management {
        server rabbitmq:15672;
    }

    # ============ Microservices ============
    # Docker 네트워크 내 서비스
    upstream notification_service {
        server notification-service:8080;
    }

    upstream notification_sender_service {
        server notification-sender-service:8080;
    }

    # 외부 서비스 (IP 주소를 환경에 맞게 수정)
    # upstream auth_service {
    #     server 192.168.x.x:8081;
    # }
    # upstream user_service {
    #     server 192.168.x.x:8082;
    # }
    # upstream product_service {
    #     server 192.168.x.x:8083;
    # }

    # ============ HTTP Server (80) ============
    server {
        listen 80;
        server_name your-domain.com www.your-domain.com;

        # Let's Encrypt 인증서 갱신
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # Health check
        location /health {
            access_log off;
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # HTTPS로 리다이렉트
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ============ HTTPS Server (443) ============
    server {
        listen 443 ssl;
        http2 on;
        server_name your-domain.com www.your-domain.com;

        # SSL 인증서 (경로를 환경에 맞게 수정)
        ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

        # SSL 최적화
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        client_max_body_size 100M;

        # ============ Infrastructure Services ============

        # Eureka Server 1
        location /eureka1/ {
            proxy_pass http://eureka1/eureka1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Eureka Server 2
        location /eureka2/ {
            proxy_pass http://eureka2/eureka2/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Config Server
        location /config/ {
            proxy_pass http://config/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Zipkin
        location /zipkin/ {
            proxy_pass http://zipkin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ============ Monitoring Services ============

        # Grafana
        location /grafana/ {
            proxy_pass http://grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Kibana
        location /kibana/ {
            proxy_pass http://kibana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            rewrite ^/kibana$ /kibana/ permanent;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Prometheus
        location /prometheus/ {
            proxy_pass http://prometheus/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Alertmanager
        location /alertmanager/ {
            proxy_pass http://alertmanager;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Pushgateway
        location /pushgateway/ {
            proxy_pass http://pushgateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # RabbitMQ Management
        location /rabbitmq/ {
            proxy_pass http://rabbitmq_management/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ============ Microservices API ============

        # Notification Service API
        location /api/v1/notifications {
            proxy_pass http://notification_service/api/v1/notifications;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Notification Sender Service API
        location /api/v1/notification-sender {
            proxy_pass http://notification_sender_service/api/v1/notification-sender;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ============ Health Check ============
        location /health {
            access_log off;
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # ============ Default ============
        location / {
            return 200 "Tickatch Infrastructure Running\n";
            add_header Content-Type text/plain;
        }
    }
}
